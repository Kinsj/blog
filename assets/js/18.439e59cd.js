(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{360:function(s,t,a){"use strict";a.r(t);var n=a(43),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"rails"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rails"}},[s._v("#")]),s._v(" Rails")]),s._v(" "),a("p",[s._v("已记账项目为例")]),s._v(" "),a("p",[s._v("在任何项目架构的第一步，首先要画出用例图，这里就不画了。"),a("br"),s._v("\n直接给出数据库结构：")]),s._v(" "),a("p",[s._v("表：")]),s._v(" "),a("ul",[a("li",[s._v("users")]),s._v(" "),a("li",[s._v("records")]),s._v(" "),a("li",[s._v("tags")]),s._v(" "),a("li",[s._v("taggings  表示 records 和 tags 的关联")]),s._v(" "),a("li",[s._v("password_reset_requests 记录所有重置请求")])]),s._v(" "),a("h2",{attrs:{id:"数据库设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库设计"}},[s._v("#")]),s._v(" 数据库设计")]),s._v(" "),a("h3",{attrs:{id:"users表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#users表"}},[s._v("#")]),s._v(" users表")]),s._v(" "),a("ul",[a("li",[s._v("注册：邮箱、密码、确认密码")]),s._v(" "),a("li",[s._v("数据库不保存明文密码，只存密文")]),s._v(" "),a("li",[s._v("加密使用最佳实践 "),a("code",[s._v("has_secure_password")])]),s._v(" "),a("li",[s._v("密文叫什么？最佳实践 "),a("code",[s._v("password_digest")])]),s._v(" "),a("li",[s._v("注册成功之后使用"),a("code",[s._v("mailer")]),s._v("发欢迎邮件")]),s._v(" "),a("li",[s._v("需要强制用户验证邮箱吗？可以强制，也可以不强制"),a("br"),s._v("\n结论： users 表有两个字段 "),a("code",[s._v("email")]),s._v(" 和 "),a("code",[s._v("password_digest")])])]),s._v(" "),a("h2",{attrs:{id:"注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册"}},[s._v("#")]),s._v(" 注册")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("rails g model User email:string password_digest:string")]),a("br"),s._v("\n创建（generate）一个 User 的 model（MVC的M），这个model包含 email 和 password_digest字段，并指定了字段类型。"),a("br"),s._v("\n生成的是 User 表的迁移代码")]),s._v(" "),a("li",[a("code",[s._v("rails db:migrate")]),s._v(" 会执行之前生成的迁移代码，创建出user表"),a("br"),s._v("\n表中包含了"),a("code",[s._v("id")]),s._v(" "),a("code",[s._v("email")]),s._v(" "),a("code",[s._v("password_digest")]),s._v(" "),a("code",[s._v("created_at")]),s._v(" "),a("code",[s._v("updated_at")]),s._v(" 字段"),a("br"),s._v("\nrails的强大之处就是用最少的代码实现最多的功能，很快就会有所体现")]),s._v(" "),a("li",[s._v("首先来实现密码加密功能"),a("code",[s._v("has_secrue_password")]),s._v(" "),a("ul",[a("li",[s._v("需要用到一个新的包"),a("code",[s._v("bcrypt")]),s._v("，去Gemfiles里取消注释"),a("code",[s._v("gem 'bcrypt', '~> 3.1.7'")])]),s._v(" "),a("li",[s._v("在User.rb(model)里加入一句话 "),a("code",[s._v("has_secure_password")]),a("br"),s._v("\n就实现了密码加密的功能")])])])]),s._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 往数据库里添加一行记录的操作：  ")]),s._v("\nu "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2@qq.com'")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123'")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password_comfirmation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 故意输错使用 u.errors 查看错误信息")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只需要调用 save 就会自动生成sql语句往数据库里添加一条记录")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("authenticate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证密码可以获取用户所有信息，不用关心加密解密")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3@qq.com'")]),s._v("\nu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据库里的记录就会被修改")]),s._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[a("p",[s._v("创建 controller")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("rails g controller users")]),s._v(" 命令创建 users controller")]),s._v(" "),a("li",[s._v("创建增删改查路由，在"),a("code",[s._v("routes.rb")]),s._v("里添加以下代码"),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Rails")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("application"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("routes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("draw "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  get "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'first#hello'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# get('/hello', {to: 'first#hello'}) 的缩写")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 'first#hello' 代表 在 first 这个 controller 上 的 hello 方法 （controller 是 MVC 的 C）")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# get '/users', to: 'users#index' # 查全部")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# get '/users/:id', to: 'users#show' # 查单个")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# post '/users', to: 'users#create' # 增")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# delete '/users/:id', to: 'users#destroy' # 删")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# patch '/users/:id', to: 'users#update' # 改")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rails提供了一句话代替以上全部5行代码：")]),s._v("\n  resources "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":users")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("去 users_controller.rb 里实现以上五种方法")])])]),s._v(" "),a("li",[a("p",[s._v("添加参数校验")])])]),s._v(" "),a("ul",[a("li",[s._v("在 Model 里添加 validates 代码就可以对参数进行校验，如以下代码："),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# models/user.rb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationRecord")]),s._v("\n  has_secure_password\n\n  validates_presence_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证 email 必须存在")]),s._v("\n  validates_presence_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证 password_confirm 必须 在create时 存在")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上面因为已经指定了 has_secure_password, 所以 :password 的存在一定会被校验，所以下面这里就不用加 :password了")]),s._v("\n  alidates_format_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token regex"}},[s._v("/.+@.+/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# format_of 传入 参数名， with: 正则，就可以校验，只在传了email的情况下才做此校验")]),s._v("\n  validates_length_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" minimum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# length_of 传入 参数名， 最大/最小长度，只在传入password的情况下才做此校验")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])])]),s._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[s._v("把结果返回给前端，render :json")])]),s._v(" "),a("ul",[a("li",[s._v("判断 user.save 的结果，正确则返回 json: user, status: 200。失败就返回 json: user.errors, status: 400")]),s._v(" "),a("li",[s._v("贴出 user_controller.rb"),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UsersController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationController")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# params  # params 就是用户传过来的参数，可以打印看看")]),s._v("\n    user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password_confirmation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 user.save 成功，返回这个user, 并添加状态码")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 user.save 失败（校验失败）,把错误返回给前台")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])])]),s._v(" "),a("ol",{attrs:{start:"7"}},[a("li",[a("s",[a("em",[s._v("中文错误码")])]),s._v(" 国际化！")])]),s._v(" "),a("ul",[a("li",[s._v("用 I18n 做国际化")]),s._v(" "),a("li",[a("code",[s._v("config/locales/")]),s._v(" 下添加 "),a("code",[s._v("zh-CN.yml")]),s._v("，内容靠错误提示补全的，要确保翻译需要"),a("strong",[s._v("单元测试")]),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("zh-CN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("activerecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("errors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("models")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("attributes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("blank")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 密码不能为空\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("too_short")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 密码不能少于 6 个字符\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("blank")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 邮箱不能为空\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("invaild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 邮箱必须含有 @ 字符\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("black")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 请填写确认密码\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 两次输入的密码不匹配\n")])])])]),s._v(" "),a("li",[s._v("在"),a("code",[s._v("config/initializers/")]),s._v(" 下添加 "),a("code",[s._v("locale.rb")]),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("I18n")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("available_locales "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":en")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zh-CN'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置可用区域白名单")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("I18n")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("default_locale "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zh-CN'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置默认区域，这个区域的设置会去 config/locales/zh-CN.yml里读取配置")]),s._v("\n")])])])])]),s._v(" "),a("ol",{attrs:{start:"8"}},[a("li",[s._v("优化代码：")])]),s._v(" "),a("ul",[a("li",[s._v("待优化代码："),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UsersController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationController")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# params  # params 就是用户传过来的参数，可以打印看看")]),s._v("\n    user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password_confirmation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 user.save 成功，返回这个user, 并添加状态码")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 user.save 失败（校验失败）,把错误返回给前台")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("优化思路：\n"),a("ul",[a("li",[a("code",[s._v("User.new")]),s._v(" 可以传参，{✉️ params[:email], :password: params[:password]...}")]),s._v(" "),a("li",[a("code",[s._v("params.permit(:email, :password, :password_comfirmation)")]),s._v(" 可以表示 params 过滤出参数组成键值对")]),s._v(" "),a("li",[a("code",[s._v("user.errors.empty?")]),s._v(" 可以检查是否有error，有则"),a("code",[s._v("render errors")]),s._v("，没有则"),a("code",[s._v("render user")])]),s._v(" "),a("li",[s._v("如果先new 一个 model 再 save它。可以使用 create。 "),a("code",[s._v("User.create")])])])]),s._v(" "),a("li",[s._v("优化结果："),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把 render_resource 方法提升到 application_controller里面，所有controller可以共享")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# application_controller.rb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ActionController")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("API")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("render_resource")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("empty"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v("\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      render json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# users_controller.rb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UsersController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationController")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")])]),s._v("\n    render_resource "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create create_params  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只需要这一行代码就可完成用户的创建和校验（校验实际是在model中完成）")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_params")])]),s._v("\n    params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("permit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ruby 不用写return")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])])]),s._v(" "),a("h2",{attrs:{id:"注册成功发送欢迎邮件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册成功发送欢迎邮件"}},[s._v("#")]),s._v(" 注册成功发送欢迎邮件")]),s._v(" "),a("p",[s._v("使用 mailer 发送邮件，教程可以看"),a("a",{attrs:{href:"https://ruby-china.github.io/rails-guides/action_mailer_basics.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1),s._v("，也可以跟着下面的步骤走：")]),s._v(" "),a("ol",[a("li",[s._v("使用命令创建 mailer\n"),a("ul",[a("li",[a("code",[s._v("rails g mailer UserMailer")])])])]),s._v(" "),a("li",[s._v("修改 "),a("code",[s._v("app/mailers/application_mailer.rb")]),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationMailer")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ActionMailer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Base")]),s._v("\n  default from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1037671280@qq.com'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从哪个邮箱发出去，这里用我自己的qq邮箱")]),s._v("\n  layout "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mailer'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 系统默认就有")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("定义邮件的发送程序，修改刚刚用生成器生成的文件"),a("code",[s._v("user_mailer.rb")]),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserMailer")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationMailer")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("welcome_email")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" user "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用 @ 开头是为了让模板里能访问到这个变量")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@url")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://jinshengjie.com'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 项目的域名")]),s._v("\n    mail"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" subject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'欢迎来到 Morney'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("创建邮件视图\n"),a("ul",[a("li",[s._v("在 "),a("code",[s._v("app/views/user_mailer/")]),s._v("目录下创建视图文件："),a("code",[s._v("welcome_email.html.erb")]),s._v("（必须叫这个文件名，和方法名一致）")]),s._v(" "),a("li",[a("strong",[a("code",[s._v("welcome_email.html.erb")])]),a("div",{staticClass:"language-erb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-erb"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token erb language-erb"}},[a("span",{pre:!0,attrs:{class:"token delimiter punctuation"}},[s._v("<%=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token delimiter punctuation"}},[s._v("%>")])]),s._v(" 你好，"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("欢迎来到 Morney, 请记一笔账吧"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])])])])]),s._v(" "),a("li",[s._v("调用邮件发送程序 "),a("code",[s._v("welcom_email")]),s._v(", 在用户创建好之后\n"),a("ul",[a("li",[s._v("之前的 "),a("code",[s._v("User.create")]),s._v(" 就改为："),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")])]),s._v("\n  user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create create_params\n  render_resource user\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UserMailer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("welcome_email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deliver_later "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里如果用deliver_now的话会等到邮件发送成功后才返回数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])])])]),s._v(" "),a("li",[s._v("配置邮箱发送服务\n"),a("ul",[a("li",[s._v("在"),a("code",[s._v("config/environment/development.rb")]),s._v("下配置mailer相关的配置"),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#...")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Don't care if the mailer can't send.")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# config.action_mailer.raise_delivery_errors = false")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# config.action_mailer.perform_caching = false")]),s._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("action_mailer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delivery_method "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":smtp")]),s._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("action_mailer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("raise_delivery_errors "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("action_mailer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("perform_caching "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("action_mailer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("smtp_settings "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    address"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_domain'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_port'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    domain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_domain'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    user_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_user_name'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_password'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    authentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_authentication'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    enable_starttls_auto"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_enable_starttls_auto'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("action_mailer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("preview_path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Rails")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('/spec/mailers/previews"')]),s._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#...")]),s._v("\n")])])])]),s._v(" "),a("li",[a("code",[s._v("Gemfile")]),s._v("里添加 "),a("code",[s._v("gem 'dotenv-rails'")]),s._v(", 并安装依赖："),a("code",[s._v("bundle install")])]),s._v(" "),a("li",[a("code",[s._v("application.rb")]),s._v(" 里调用 dotenv"),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Require the gems listed in Gemfile, including any gems")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# you've limited to :test, :development, or :production.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Bundler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Rails")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("groups"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Dotenv")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Railtie")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load\n")])])])]),s._v(" "),a("li",[s._v("编辑 .env 和 .env.local"),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# .env")]),s._v("\nexport smtp_domain"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp.qq.com'")]),s._v("\nexport smtp_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'587'")]),s._v("\nexport smtp_user_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\nexport smtp_password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\nexport smtp_authentication"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'plain'")]),s._v("\nexport smtp_enable_starttls_auto"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nexport mailer_sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把用户名和密码存在 .env.local 里。（把用户名密码这种敏感信息存在本地环境变量里，不提交到代码里！防止泄露隐私）!")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ！！！重要！！！ 把 .env.local 加入 .gitignore 保证文件不被提交")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("测试发送成功")])])])]),s._v(" "),a("h2",{attrs:{id:"遗留问题：邮箱不能重复！"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#遗留问题：邮箱不能重复！"}},[s._v("#")]),s._v(" 遗留问题：邮箱不能重复！")]),s._v(" "),a("p",[s._v("解决这个问题当然就是改 Model, "),a("code",[s._v("user.rb")])]),s._v(" "),a("ul",[a("li",[s._v("在user.rb 里 添加一个validate "),a("code",[s._v("validates_uniqueness_of :email")]),s._v(" # 保证 email 是唯一的")]),s._v(" "),a("li",[s._v("但是这个时候 "),a("code",[s._v("User.create")]),s._v(" 可能会报错，因为发送邮件的对象是一个user，这个user由于校验失败，没有被添加到数据库")]),s._v(" "),a("li",[s._v("所以发送邮件的语句要改成"),a("br"),s._v(" "),a("code",[s._v("UserMailer.welcome_email(user).deliver_later if user.persisted? # 判断一下，如果这个user已经被持久化到数据库，才发送")])]),s._v(" "),a("li",[s._v("再进一步思考这个问题，我们在成功创建这个数据到数据库之后，调用一次发送欢迎邮箱就可以了，所以我们可以改造一下我们的 Model: "),a("code",[s._v("user.rb")]),a("br"),s._v("\n所以最终我们的代码变为："),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user.rb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationRecord")]),s._v("\n  has_secure_password\n\n  validates_presence_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证 email 必须存在")]),s._v("\n  validates_uniqueness_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证 email 是唯一的")]),s._v("\n  validates_presence_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证 password_confirm 必须 在create时 存在")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上面因为已经指定了 has_secure_password, 所以 :password 的存在一定会被校验，所以下面这里就不用加 :password了")]),s._v("\n\n  validates_format_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token regex"}},[s._v("/.+@.+/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# format_of 传入 参数名， with: 正则，就可以校验")]),s._v("\n  validates_length_of "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" minimum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# length_of 传入 参数名， 最大/最小长度")]),s._v("\n\n  after_create "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":send_welcome_email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建完成后调用函数 :send_welcome_email，类似回调函数")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_welcome_email")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UserMailer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("welcome_email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deliver_later "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# self 就是 user本身")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])]),a("div",{staticClass:"language-rb extra-class"},[a("pre",{pre:!0,attrs:{class:"language-rb"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# users_controller.rb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UsersController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ApplicationController")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")])]),s._v("\n    render_resource "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create create_params "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回到了最简洁的样子")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_params")])]),s._v("\n    params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("permit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":email")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":password_confirmation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ruby 不用写return")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);